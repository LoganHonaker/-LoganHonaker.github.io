YUI.add("photo-contexts-models",(function(e){function t(e){t.superclass.constructor.call(this,e),this.getMorePromises={"group-pool-models":{},"set-models":{},"gallery-models":{}},this.continuationKeys={"group-pool-models":{},"set-models":{},"gallery-models":{}}}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{read:function(t){return this.appContext.flipper.isFlipped("enable-scrappy-photo-page")?e.ModelFetchers["flickr-photos-getAllContexts"].run(t,this.appContext):e.ModelFetchers["flickr-photos-getInfo"].run(t,this.appContext)}},getMoreContextsOfType:function(t,r,o){var s,n,i,l,a,p,u,c=this,g="-1",d=e.APIHelper.request.getRebootPhotoExtras();switch(r){case"group-pool-models":s="flickr.photos.getGroups",i="groups.group",d+=","+e.APIHelper.request.getRebootGroupExtras();break;case"set-models":s="flickr.photos.getSets",i="sets.set";break;case"gallery-models":s="flickr.photos.getGalleries",i="galleries.gallery"}return s?this.exists(t)?(l=this.continuationKeys[r][t]||"0")===g?e.Promise.resolve({type:r,newContexts:[],loadedAll:!0}):(n={photo_id:t,extras:d,primary_photo_extras:"url_sq, url_t, url_s, url_m",continuation:l,per_page:o},p=t+"_"+l,(u=this.getMorePromises[r][p])?u:(this.getMorePromises[r][p]=new e.FlickrPromise({apiResponse:this.appContext.callAPI(s,n,!0),contextRegistry:this.appContext.getModelRegistry(r),personRegistry:this.appContext.getModelRegistry("person-models")}).then((function(o){var s,n,l,u=[],d=o.apiResponse,f=o.contextRegistry,h=o.personRegistry;return(n=i.split(".").reduce((function(t,r){return e.Lang.isObject(t)?t[r]:void 0}),d))&&(e.Array.each(n,(function(t){e.APIHelper.response.addContextToRegistry(t,f,h),u.push(f.proxy(t.id))})),u.length&&(l=c.getContextsOfType(t,r).map((function(e){return e.getValue("id")})),(u=u.filter((function(e){return-1===l.indexOf(e.getValue("id"))}))).length&&c.getValue(t,"contexts").appendToListMulti(u))),void 0===(a=d.continuation)?a=g:e.Lang.isNumber(a)&&(a+=""),s=a===g,c.continuationKeys[r][t]=a,delete c.getMorePromises[r][p],{type:r,newContexts:u,loadedAll:s}})),this.getMorePromises[r][p])):e.Promise.reject("[photo-contexts-models] getMoreContextsOfType was called for an ID that isn't in the registry: "+t):e.Promise.reject("[photo-contexts-models] getMoreContextsOfType was called without an invalid type: "+r)},getContextsOfType:function(t,r){return r=e.Array(r),this.getValue(t,"contexts").getList().filter((function(e){return r.indexOf(e.registry.name)>-1}))},getContextsNotOfType:function(t,r){return r=e.Array(r),this.getValue(t,"contexts").getList().filter((function(e){return-1===r.indexOf(e.registry.name)}))},attributes:{contexts:{isCollection:!0},totalGroups:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},totalSets:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},totalGalleries:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0}}})}),"@VERSION@",{requires:["api-helper","flickr-model-registry","flickr-promise","flickr-photos-getInfo-fetcher","flickr-photos-getAllContexts-fetcher"]});YUI.add("flickr-photosets-search-fetcher",(function(e,t){"use strict";function s(t){var s,r={extras:e.APIHelper.request.getRebootSearchSetsExtras(),per_page:t.perPage||50,page:t.page||1};return s=e.merge(r,t.apiParams||{}),YUI.Env.isServer&&e.SearchHelper.unescapeParameters(s),s}e.namespace("ListFetchers")["flickr-photosets-search"]={run:function(r,o){var a=this,p=r.emptyQuery?{}:s(r),h=p.user_id;return h?e.Promise.all([r.emptyQuery?e.Promise.resolve({photos:{photo:[]}}):o.callAPI("flickr.photosets.search",p),o.getModelRegistry("search-sets-models"),o.getModelRegistry("set-models"),o.getModel("person-models",h)]).then((function(e){return a._processResponse(e,r)}),e.FetcherErrorLogger(t)):e.Promise.reject("[flickr-photosets-search-fetcher] called without `user_id` param")},_processParams:s,_processResponse:function(t,s){var r,o,a=[],p=[],h=t[0],l=t[1],i=t[2],c=h.photosets.photoset.length;for(o=0;o<c;o++)(a=e.APIHelper.response.parsePhotoSetMeta(h.photosets.photoset[o])).owner=t[3],i.addOrUpdate(a),p.push(i.proxy(a.id));r={id:s.id,totalItems:parseInt(h.photosets.total||0,10)};let n=parseInt(h.photosets.perpage),d=parseInt(h.photosets.page);return r.sets={page:d,perPage:n,pageContent:p,totalItems:h.photosets.total,totalPages:Math.ceil(h.photosets.total/n)},l.addOrUpdate(r),p}}}),"@VERSION@",{requires:["flickr-promise","search-helper","api-helper","set-models","querystring-parse-simple"],optional:[]});YUI.add("search-sets-models",(function(e){function t(e){t.superclass.constructor.call(this,e)}e.Models[this.name]=t,e.extend(t,e.FlickrModelRegistry,{name:this.name,remote:{read:function(t){return e.ListFetchers["flickr-photosets-search"].run(t,this.appContext)}},attributes:{id:{},sets:{isCollection:!0,pageFetch:{listFetcher:e.ListFetchers["flickr-photosets-search"],listItemIdField:"id"}},apiParams:{writeOnce:"initOnly"},totalItems:{validator:function(t){return e.AttributeHelpers.validateInteger(t)},setter:function(t){return e.AttributeHelpers.coerceInteger(t)},defaultValue:0},emptyQuery:{defaultValue:!1}}})}),"@VERSION@",{requires:["flickr-model-registry","flickr-photosets-search-fetcher","search-helper"]});YUI.add("hermes-template-search-photos-album-item",(function(e,l){var a=e.Template.Handlebars.revive({compiler:[8,">= 4.3.0"],main:function(e,l,a,t,n){var r,s,u=null!=l?l:e.nullContext||{},o=e.hooks.helperMissing,i="function",c=e.escapeExpression,m=e.lookupProperty||function(e,l){if(Object.prototype.hasOwnProperty.call(e,l))return e[l]};return'<a href="'+c(typeof(s=null!=(s=m(a,"url")||(null!=l?m(l,"url"):l))?s:o)===i?s.call(u,{name:"url",hash:{},data:n,loc:{start:{line:1,column:9},end:{line:1,column:16}}}):s)+'" class="search-photos-album-item"><div class="avatar album huge" style="background-image:url('+c(e.lambda(null!=(r=null!=(r=null!=l?m(l,"primaryPhotoSizes"):l)?m(r,"q"):r)?m(r,"src"):r,l))+')">\n\t<sup>'+c(typeof(s=null!=(s=m(a,"title")||(null!=l?m(l,"title"):l))?s:o)===i?s.call(u,{name:"title",hash:{},data:n,loc:{start:{line:2,column:6},end:{line:2,column:15}}}):s)+"</sup>\n\t<sub>"+c((m(a,"intlHTMLMessage")||l&&m(l,"intlHTMLMessage")||o).call(u,{name:"intlHTMLMessage",hash:{count:null!=l?m(l,"photoCount"):l,intlName:"search.GROUP_PHOTO_COUNT"},data:n,loc:{start:{line:3,column:6},end:{line:3,column:78}}}))+"</sub>\n</div></a>"},useData:!0}),t={};e.Array.each([],(function(l){var a=e.Template.get("hermes/"+l);a&&(t[l]=a)})),e.Template.register("hermes/search-photos-album-item",(function(l,n){return(n=n||{}).partials=n.partials?e.merge(t,n.partials):t,a(l,n)}))}),"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("hermes-template-search-photos-albums",(function(l,n){var e=l.Template.Handlebars.revive({1:function(l,n,e,t,a){var r,o=null!=n?n:l.nullContext||{},s=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return'\t<h5 class="search-results-header">'+(null!=(r=s(e,"unless").call(o,null!=n?s(n,"loading"):n,{name:"unless",hash:{},fn:l.program(2,a,0),inverse:l.noop,data:a,loc:{start:{line:2,column:35},end:{line:2,column:379}}}))?r:"")+l.escapeExpression((s(e,"intlMessage")||n&&s(n,"intlMessage")||l.hooks.helperMissing).call(o,{name:"intlMessage",hash:{intlName:"search.YOUR_ALBUMS"},data:a,loc:{start:{line:2,column:379},end:{line:2,column:424}}}))+" "+(null!=(r=s(e,"if").call(o,null!=n?s(n,"loading"):n,{name:"if",hash:{},fn:l.program(8,a,0),inverse:l.noop,data:a,loc:{start:{line:2,column:425},end:{line:2,column:485}}}))?r:"")+"</h5>\n"+(null!=(r=s(e,"if").call(o,null!=n?s(n,"loading"):n,{name:"if",hash:{},fn:l.program(10,a,0),inverse:l.program(12,a,0),data:a,loc:{start:{line:3,column:1},end:{line:11,column:8}}}))?r:"")},2:function(l,n,e,t,a){var r,o=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return null!=(r=o(e,"if").call(null!=n?n:l.nullContext||{},null!=n?o(n,"viewingAll"):n,{name:"if",hash:{},fn:l.program(3,a,0),inverse:l.program(5,a,0),data:a,loc:{start:{line:2,column:54},end:{line:2,column:368}}}))?r:""},3:function(l,n,e,t,a){var r=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return'<span class="secondary">'+l.escapeExpression((r(e,"intlHTMLMessage")||n&&r(n,"intlHTMLMessage")||l.hooks.helperMissing).call(null!=n?n:l.nullContext||{},{name:"intlHTMLMessage",hash:{count:null!=n?r(n,"total"):n,intlName:"search.RESULTS_COUNT"},data:a,loc:{start:{line:2,column:96},end:{line:2,column:159}}}))+"</span>"},5:function(l,n,e,t,a){var r,o=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return null!=(r=o(e,"unless").call(null!=n?n:l.nullContext||{},null!=n?o(n,"singleResult"):n,{name:"unless",hash:{},fn:l.program(6,a,0),inverse:l.noop,data:a,loc:{start:{line:2,column:174},end:{line:2,column:361}}}))?r:""},6:function(l,n,e,t,a){var r,o=null!=n?n:l.nullContext||{},s=l.hooks.helperMissing,i=l.escapeExpression,u=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return'<a href="'+i("function"==typeof(r=null!=(r=u(e,"viewAllLink")||(null!=n?u(n,"viewAllLink"):n))?r:s)?r.call(o,{name:"viewAllLink",hash:{},data:a,loc:{start:{line:2,column:207},end:{line:2,column:222}}}):r)+'" class="view-more-link" data-track="search-viewall-albums">'+i((u(e,"intlHTMLMessage")||n&&u(n,"intlHTMLMessage")||s).call(o,{name:"intlHTMLMessage",hash:{count:null!=n?u(n,"total"):n,intlName:"search.VIEW_ALL_COUNT"},data:a,loc:{start:{line:2,column:282},end:{line:2,column:346}}}))+"</a>"},8:function(l,n,e,t,a){return'<div class="flickr-dots inline"></div>'},10:function(l,n,e,t,a){var r,o=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return'\t\t<div style="height: '+l.escapeExpression("function"==typeof(r=null!=(r=o(e,"placeholderHeight")||(null!=n?o(n,"placeholderHeight"):n))?r:l.hooks.helperMissing)?r.call(null!=n?n:l.nullContext||{},{name:"placeholderHeight",hash:{},data:a,loc:{start:{line:4,column:22},end:{line:4,column:43}}}):r)+'px;"></div>\n'},12:function(l,n,e,t,a){var r,o,s=null!=n?n:l.nullContext||{},i=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return'\t\t<div class="results'+(null!=(r=i(e,"unless").call(s,null!=n?i(n,"viewingAll"):n,{name:"unless",hash:{},fn:l.program(13,a,0),inverse:l.noop,data:a,loc:{start:{line:6,column:21},end:{line:6,column:62}}}))?r:"")+'" style="height: '+l.escapeExpression("function"==typeof(o=null!=(o=i(e,"resultsHeight")||(null!=n?i(n,"resultsHeight"):n))?o:l.hooks.helperMissing)?o.call(s,{name:"resultsHeight",hash:{},data:a,loc:{start:{line:6,column:79},end:{line:6,column:96}}}):o)+'px;">\n'+(null!=(r=i(e,"each").call(s,null!=n?i(n,"albums"):n,{name:"each",hash:{},fn:l.program(15,a,0),inverse:l.noop,data:a,loc:{start:{line:7,column:3},end:{line:9,column:12}}}))?r:"")+"\t\t</div>\n"},13:function(l,n,e,t,a){return" unified"},15:function(l,n,e,t,a){var r,o=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return null!=(r=l.invokePartial(o(t,"search-photos-album-item"),n,{name:"search-photos-album-item",data:a,indent:"\t\t\t\t",helpers:e,partials:t,decorators:l.decorators}))?r:""},compiler:[8,">= 4.3.0"],main:function(l,n,e,t,a){var r,o=l.lookupProperty||function(l,n){if(Object.prototype.hasOwnProperty.call(l,n))return l[n]};return null!=(r=o(e,"unless").call(null!=n?n:l.nullContext||{},null!=n?o(n,"emptySearch"):n,{name:"unless",hash:{},fn:l.program(1,a,0),inverse:l.noop,data:a,loc:{start:{line:1,column:0},end:{line:12,column:11}}}))?r:""},usePartial:!0,useData:!0}),t={};l.Array.each(["search-photos-album-item"],(function(n){var e=l.Template.get("hermes/"+n);e&&(t[n]=e)})),l.Template.register("hermes/search-photos-albums",(function(n,a){return(a=a||{}).partials=a.partials?l.merge(t,a.partials):t,e(n,a)}))}),"@VERSION@",{requires:["template-base","handlebars-base","hermes-template-search-photos-album-item"]});YUI.add("hermes-template-flickr-balls",(function(e,l){var a=e.Template.Handlebars.revive({1:function(e,l,a,r,n){return" block"},compiler:[8,">= 4.3.0"],main:function(e,l,a,r,n){var t,i=e.lookupProperty||function(e,l){if(Object.prototype.hasOwnProperty.call(e,l))return e[l]};return'<div class="balls '+(null!=(t=i(a,"if").call(null!=l?l:e.nullContext||{},null!=l?i(l,"isBlock"):l,{name:"if",hash:{},fn:e.program(1,n,0),inverse:e.noop,data:n,loc:{start:{line:1,column:18},end:{line:1,column:46}}}))?t:"")+'">\n\t<div class="blue ball"></div><div class="pink ball"></div>\n</div>'},useData:!0}),r={};e.Array.each([],(function(l){var a=e.Template.get("hermes/"+l);a&&(r[l]=a)})),e.Template.register("hermes/flickr-balls",(function(l,n){return(n=n||{}).partials=n.partials?e.merge(r,n.partials):r,a(l,n)}))}),"@VERSION@",{requires:["template-base","handlebars-base"]});YUI.add("search-photos-albums-view",(function(e,t){var i=require("hermes-core/flog")(t);e.FlickrView.create(this.name,e.FlickrView,[],{langBundles:this.details.langBundles,emptySearch:!1,initializer:function(t){return""===this.get("container").get("innerHTML")&&this.setContainerWithTemplate("search-photos-albums",{loading:!0,placeholderHeight:120}),this.unifiedSubviewParams=t.unifiedSubviewParams||{},this.unifiedSubviewParams.albums&&this.unifiedSubviewParams.albums.fetchParams?(this.fetchParams=this.unifiedSubviewParams.albums.fetchParams,this.apiParams=e.merge(this.fetchParams.apiParams||{}),this.searchId=this.unifiedSubviewParams.albums.id):(this.apiParams={},this.fetchParams={}),this.searchUrl=new e.SearchUrl(this.apiParams,this.appContext,e.SearchUrl.searchTypes.PHOTOS),this.viewingAll=this.apiParams[e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll],this.albumWidth=0,this.albumMarginWidth=0,this.albumResultsContainer=null,this.pageNum=0,this.initialAlbumModels=[],this},loadState:function(){var e,t=this;return this.appContext.getModel("search-sets-models",this.searchId||this.searchUrl.getId(),this.fetchParams).then((function(i){(e=i.getValue("sets"))&&e.toJSON().length<1&&(t.emptySearch=!0),t.searchModel=i,t.initialAlbumModels=t.searchModel.getValue("sets").getList()}))},buildContainer:function(){var t;return this.searchUrl.setAPIParam(e.SearchHelper.UNIFIED_STATE_PARAMS.albums,!0),this.searchUrl.setAPIParam(e.SearchHelper.UNIFIED_STATE_PARAMS.viewAll,!0),t={albums:this.searchModel.getValue("sets").toJSON(),total:this.searchModel.getValue("totalItems"),singleResult:1===this.searchModel.getValue("totalItems"),emptySearch:this.emptySearch,viewAllLink:this.searchUrl.getURL(),viewingAll:this.viewingAll,resultsHeight:this.viewingAll?void 0:130},this.setContainerWithTemplate("search-photos-albums",t),this},activate:function(){var t=this,i=this.get("container"),s=i.one(".album");if(this.albumResultsContainer=i.one(".results"),!this.viewingAll&&s&&(this.albumWidth=s.get("offsetWidth"),this.albumMarginWidth=14,this.albumWidth+=this.albumMarginWidth,this.registerEventHandler(e.globalEvents.subscribe("window:resize",this.quantizeContainerWidth.bind(this))),this.quantizeContainerWidth(null)),this.viewingAll)return this.registerEventHandler(e.globalEvents.subscribe("window:scroll",e.betterThrottle(this.handleScroll.bind(this),100,this,!1))),this.loadMore().then((function(e){var i=(e=e.filter((function(e){return!t.initialAlbumModels.find((function(t){return t.id===e.id}))}))).map((function(e){return e.toJSON()}));return t.appendItems(i)}))},quantizeContainerWidth:function(e){var t,i=this.get("container").get("clientWidth");t=i-i%this.albumWidth+1,this.albumResultsContainer.setStyle("width",t+"px")},handleScroll:function(){var e=this;!this.isLoadingMore&&!this.isAtEnd&&this.albumResultsContainer.getDOMNode().getBoundingClientRect().bottom<this.appContext.viewportData.getHeight()+400&&this.loadMore().then((function(t){var i=t.map((function(e){return e.toJSON()}));e.appendItems(i)}))},loadMore:function(){var t,s=this;if(this.isLoadingMore||this.isAtEnd)return e.Promise.resolve([]);this.isLoadingMore=!0,this.pageNum++,t=Object.assign({},this.unifiedSubviewParams.albums.fetchParams,{page:this.pageNum,perPage:100});var a=e.Node.create('<div class="loader">'),r=s.templates("flickr-balls")({});return a.appendChild(r),s.albumResultsContainer.appendChild(a),this.searchModel.getValue("sets").getPage(t).then((function(e){return s.isLoadingMore=!1,s.isAtEnd=s.searchModel.getValue("sets").size()>=s.searchModel.getValue("totalItems"),a.remove(),e})).catch((function(e){s.pageNum--,s.isLoadingMore=!1,a.remove(),i.error("Error loading more albums",{err:e})}))},appendItems:function(t){var i=this;return t.forEach((function(e){var t=i.templates("search-photos-album-item")(e);i.albumResultsContainer.append(t)})),e.Promise.resolve()}},{ATTRS:{}})}),"@VERSION@",{requires:["flickr-view","flickr-promise","search-sets-models","search-url","search-helper","hermes-template-search-photos-albums","hermes-template-search-photos-album-item","hermes-template-flickr-balls"],optionalRequires:["global-events","hermes-core"],langBundles:["search","common"]});